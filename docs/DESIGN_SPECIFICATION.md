# 設計仕様書：非対話モードClaude Code ワークフロー

**作成日**: 2025-11-16
**ステータス**: 📝 要件定義中

---

## 目的

この文書は、理論的に完璧な非対話モードClaude Codeワークフローシステムを設計するための仕様書です。

**設計方針**:
1. 理論的な正しさを保証
2. ユーザー要件を完全に満たす
3. 実装前に完璧な設計を完成
4. テストで修正点をあぶり出す

---

## フェーズ1: 要件定義

### 1.1 ユーザー要件（未確定）

**質問事項**:

#### A. 作りたいものは何ですか？

- [ ] **目的**:
  - データ処理パイプライン？
  - コード生成自動化？
  - 分析・レポート生成？
  - その他？

- [ ] **入力形式**:
  - ファイル（CSV, JSON, テキスト）？
  - プロンプトテンプレート？
  - データベースクエリ？
  - その他？

- [ ] **出力形式**:
  - レポート（MD, HTML, PDF）？
  - 生成されたコード？
  - 処理済みデータ？
  - 判断結果・推奨事項？
  - その他？

- [ ] **規模**:
  - 短い（1-3ステップ）？
  - 中程度（5-10ステップ）？
  - 長い（10-100ステップ）？
  - 非常に長い（100+ステップ）？

#### B. 非対話モード要件

- [ ] **実行環境**:
  - ローカルマシン？
  - CI/CD？
  - サーバー？
  - その他？

- [ ] **実行頻度**:
  - 一度だけ？
  - 定期的（cron）？
  - イベント駆動？
  - その他？

- [ ] **並列性**:
  - 単一プロセス？
  - 複数ワークフロー並列？
  - その他？

#### C. 制約条件

- [ ] **優先順位** (高→低):
  1. _______________
  2. _______________
  3. _______________

- [ ] **制約**:
  - [ ] コスト制約（トークン数制限）
  - [ ] 速度制約（実行時間制限）
  - [ ] 精度制約（エラー率制限）
  - [ ] その他: _______________

#### D. 現状の課題

- [ ] ローカル実装で困っていること:
  - _______________
  - _______________

- [ ] 改善したいこと:
  - _______________
  - _______________

---

## フェーズ2: 技術仕様（調査中）

### 2.1 Claude Code CLI 仕様

#### 確認済み

✅ **基本コマンド**:
```bash
claude -p <prompt> --output-format json --dangerously-skip-permission
```

✅ **出力フォーマット**:
- `json`: 構造化JSON出力
- `stream-json`: ストリーミングJSON
- `text`: プレーンテキスト（デフォルト）

✅ **tool_use構造**:
```json
{
  "type": "tool_use",
  "id": "toolu_xxxxx",
  "name": "tool_name",
  "input": {...}
}
```

#### 未確認（要調査）

❓ **完全な出力構造**:
```json
{
  "messages": [...],  // ← この構造は？
  "result": {
    "content": [...],
    "stop_reason": "tool_use" | "end_turn" | ???
  }
}
```

質問:
- `messages`配列の中身は？
- `stop_reason`の全パターンは？
- エラー時の構造は？
- `--output-format stream-json`の詳細は？

❓ **tool_result の送り方**:
- 次のプロンプトに含める？（Method 1）
- 特別なフォーマットがある？（Method 2）
- `-c`フラグで会話継続？
- その他の方法？

❓ **エラーハンドリング**:
- ツール実行失敗時の動作は？
- タイムアウト時の動作は？
- API制限時の動作は？

### 2.2 調査が必要な項目

1. [ ] 公式ドキュメント完全読破
2. [ ] GitHub リポジトリのソースコード確認
3. [ ] 実際のテスト実行（小規模）
4. [ ] エッジケースの動作確認

---

## フェーズ3: アーキテクチャ設計（未着手）

### 3.1 理論的保証が必要な性質

#### 正確性（Correctness）

**定義**: システムが仕様通りに動作すること

**保証すべき性質**:
- [ ] **C1**: tool_resultは必ず次のiterationに含まれる
- [ ] **C2**: tool実行結果は正確に記録される
- [ ] **C3**: プロンプトとレスポンスの対応が保たれる
- [ ] **C4**: 状態遷移が正しい
- [ ] その他: _______________

**検証方法**:
- 形式検証？
- テストケース網羅？
- 不変条件のアサーション？

#### 完全性（Completeness）

**定義**: 全ての必要な処理が実行されること

**保証すべき性質**:
- [ ] **CP1**: 全てのtool_useが実行される
- [ ] **CP2**: 無限ループしない（停止性）
- [ ] **CP3**: 全ての出力が保存される
- [ ] その他: _______________

#### 一貫性（Consistency）

**定義**: システムの状態が一貫していること

**保証すべき性質**:
- [ ] **CS1**: メッセージ履歴が時系列順
- [ ] **CS2**: tool_use_idの一意性
- [ ] **CS3**: 依存関係が満たされる
- [ ] その他: _______________

#### 堅牢性（Robustness）

**定義**: エラーに対して適切に対処すること

**保証すべき性質**:
- [ ] **R1**: ツール実行失敗時の回復
- [ ] **R2**: ネットワークエラー時のリトライ
- [ ] **R3**: 部分実行からの再開
- [ ] その他: _______________

### 3.2 システムアーキテクチャ（未設計）

**要素**:
- [ ] オーケストレーター
- [ ] 状態管理
- [ ] ツール実行エンジン
- [ ] エラーハンドラー
- [ ] 永続化層
- [ ] その他: _______________

### 3.3 データフロー（未設計）

```
[入力] → [処理] → [出力]
```

詳細設計は要件確定後。

---

## フェーズ4: 形式的仕様（未着手）

### 4.1 状態機械

**状態**:
- `INIT`: 初期状態
- `EXECUTING`: Claude実行中
- `TOOLS_PENDING`: ツール実行待ち
- `TOOLS_EXECUTING`: ツール実行中
- `COMPLETED`: 完了
- `ERROR`: エラー

**遷移**:
```
INIT → EXECUTING → TOOLS_PENDING → TOOLS_EXECUTING → EXECUTING
                 → COMPLETED
                 → ERROR
```

詳細は後で定義。

### 4.2 不変条件（Invariants）

**I1**: `iteration_count ≥ 0`
**I2**: `for all tool_use_id: unique(tool_use_id)`
**I3**: `messages[i].timestamp < messages[i+1].timestamp`

その他、追加予定。

### 4.3 事前条件・事後条件

各関数の契約を定義（未着手）。

---

## フェーズ5: 実装計画（未着手）

### 5.1 モジュール分割

- [ ] `orchestrator.py`: メインループ
- [ ] `claude_runner.py`: Claude実行
- [ ] `tool_executor.py`: ツール実行
- [ ] `state_manager.py`: 状態管理
- [ ] `error_handler.py`: エラー処理
- [ ] その他: _______________

### 5.2 テスト戦略

- [ ] ユニットテスト
- [ ] 統合テスト
- [ ] エンドツーエンドテスト
- [ ] プロパティベーステスト
- [ ] その他: _______________

---

## フェーズ6: テスト＆検証（未着手）

### 6.1 テストケース

#### 正常系

- [ ] TC1: 単一ツール使用
- [ ] TC2: 複数ツール順次使用
- [ ] TC3: ツール未使用
- [ ] TC4: 長いワークフロー（10+ iterations）

#### 異常系

- [ ] TC5: ツール実行失敗
- [ ] TC6: ネットワークエラー
- [ ] TC7: タイムアウト
- [ ] TC8: 不正なJSON
- [ ] TC9: API制限

#### エッジケース

- [ ] TC10: 空のプロンプト
- [ ] TC11: 巨大な出力
- [ ] TC12: 特殊文字
- [ ] TC13: 並行実行

### 6.2 検証項目

- [ ] 全てのテストケースがパス
- [ ] 不変条件が常に成立
- [ ] パフォーマンス要件を満たす
- [ ] エラー処理が適切

---

## 次のステップ

### 即座に必要なこと

1. **ユーザー要件の明確化**
   - 上記の質問事項に回答
   - ユースケースの具体例

2. **技術仕様の確定**
   - `claude -p`の完全な出力構造
   - tool_resultの正しい送り方
   - エラー処理の動作

### その後の流れ

3. アーキテクチャ設計の完成
4. 形式的仕様の完成
5. 実装
6. テスト
7. 修正

---

## 付録A: 参考文献

- Claude Code CLI Reference: https://docs.claude.com/en/docs/claude-code/cli-reference
- Headless Mode: https://docs.claude.com/en/docs/claude-code/headless
- Tool Use API: https://docs.anthropic.com/en/docs/build-with-claude/tool-use

---

## 付録B: 用語集

- **Iteration**: Claude実行の1サイクル
- **tool_use**: Claudeがツール使用を要求するcontentブロック
- **tool_result**: ツール実行結果
- **stop_reason**: Claudeが停止した理由（"tool_use", "end_turn"など）

---

**ステータス**:
- ✅ フェーズ1: 要件定義 - 50%完了（ユーザー入力待ち）
- 🔍 フェーズ2: 技術仕様 - 30%完了（調査中）
- ⏸️ フェーズ3: アーキテクチャ設計 - 未着手
- ⏸️ フェーズ4: 形式的仕様 - 未着手
- ⏸️ フェーズ5: 実装計画 - 未着手
- ⏸️ フェーズ6: テスト - 未着手
