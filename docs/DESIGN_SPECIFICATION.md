# 設計仕様書：MV自動生成システム (MP3 → MP4)

**プロジェクト名**: MV Orchestra - Automated Music Video Generation System
**作成日**: 2025-11-16
**更新日**: 2025-11-16
**ステータス**: 📝 要件定義完了 → アーキテクチャ設計中

---

## エグゼクティブサマリー

### プロジェクト概要

**入力**: MP3ファイル（楽曲データ）
**出力**: MP4ファイル（完成したミュージックビデオ）
**方式**: Claude Code非対話モード（`claude -p`）による完全自動生成

### 革新性

このシステムは、楽曲から自動的にミュージックビデオを生成する、世界初の完全自律型MV生成パイプラインです。

### 設計方針

1. **理論的完璧性**: 実装前に設計を完璧に
2. **品質最優先**: 全ての要素で最高品質を追求
3. **完全自律**: 人間の介入なしで完結
4. **スケーラブル**: 任意の長さの楽曲に対応

---

## フェーズ1: 要件定義 ✅

### 1.1 ユーザー要件（確定）

#### A. プロジェクト目的

✅ **システム名**: MV Orchestra - 楽曲から音楽ビデオへの完全自動生成システム

✅ **主要機能**:
- 音声分析（ビート検出、テンポ、ムード分析）
- 歌詞抽出・意味解析
- 映像コンセプト生成（ストーリーボード）
- 映像素材の選定/生成
- タイミング・編集計算
- 映像合成・エフェクト適用
- 最終レンダリング

#### B. 入出力仕様

✅ **入力**:
- **形式**: MP3ファイル
- **要件**:
  - 任意の長さ（30秒〜10分+）
  - 標準的なビットレート（128kbps〜320kbps）
  - メタデータ（タイトル、アーティスト）があれば尚可

✅ **出力**:
- **形式**: MP4ファイル（H.264コーデック推奨）
- **品質**:
  - 解像度: 1080p (1920x1080) 以上
  - フレームレート: 24fps / 30fps / 60fps
  - ビットレート: 高品質（5-10Mbps）
- **要件**: 音楽と完全同期した映像

✅ **中間出力** (何でも可):
- 音声分析JSON
- 歌詞テキスト
- ストーリーボードMarkdown
- 映像素材リスト
- 編集スクリプト
- その他、品質向上に寄与するもの全て

#### C. 規模・スケール

✅ **ワークフロー規模**:
- **長さ**: 自律実行可能であれば制限なし
- **推定ステップ数**: 20-100ステップ（楽曲により変動）
- **実行時間**: 品質優先（数分〜数時間OK）

✅ **自律性要件**:
- 完全非対話
- 人間の確認・承認なし
- エラー時は自己修正または明確な失敗

#### D. 非対話モード要件

✅ **実行環境**:
- ローカルマシン（初期）
- 将来的にサーバー/クラウド拡張可能

✅ **実行頻度**:
- オンデマンド（楽曲ごと）
- 将来的にバッチ処理対応

✅ **並列性**:
- 単一楽曲の処理は直列
- 独立した処理（分析、素材生成など）は並列化可能

#### E. 制約条件・優先順位

✅ **優先順位** (全て最高優先度):
1. **品質** - 最も重要
2. **品質** - 最も重要
3. **品質** - 最も重要
4. 完全性（全ての処理が完了すること）
5. 堅牢性（エラー処理）
6. スケーラビリティ
7. コスト・速度（品質が保たれる範囲で最適化）

✅ **品質基準**:
- 映像と音楽の完全同期（±1フレーム以内）
- 映像の芸術的品質（プロフェッショナルレベル）
- 楽曲の意図・ムードを正確に反映
- 視覚的な一貫性・統一感

#### F. 現状の課題

✅ **主な課題**:
- **品質保証**: 自動生成でも高品質を維持したい
- **一貫性**: 複数の独立した処理の結果を統合する際の品質
- **創造性**: AIによる芸術的判断の質

✅ **改善したいこと**:
- 品質評価の自動化
- 複数案の生成と最適選択
- 段階的な品質向上メカニズム

---

## フェーズ2: 技術仕様（調査中）

### 2.1 Claude Code CLI 仕様

#### 確認済み

✅ **基本コマンド**:
```bash
claude -p <prompt> --output-format json --dangerously-skip-permission
```

✅ **出力フォーマット**:
- `json`: 構造化JSON出力
- `stream-json`: ストリーミングJSON
- `text`: プレーンテキスト（デフォルト）

✅ **tool_use構造**:
```json
{
  "type": "tool_use",
  "id": "toolu_xxxxx",
  "name": "tool_name",
  "input": {...}
}
```

#### 未確認（要調査）

❓ **完全な出力構造**:
```json
{
  "messages": [...],  // ← この構造は？
  "result": {
    "content": [...],
    "stop_reason": "tool_use" | "end_turn" | ???
  }
}
```

質問:
- `messages`配列の中身は？
- `stop_reason`の全パターンは？
- エラー時の構造は？
- `--output-format stream-json`の詳細は？

❓ **tool_result の送り方**:
- 次のプロンプトに含める？（Method 1）
- 特別なフォーマットがある？（Method 2）
- `-c`フラグで会話継続？
- その他の方法？

❓ **エラーハンドリング**:
- ツール実行失敗時の動作は？
- タイムアウト時の動作は？
- API制限時の動作は？

### 2.2 調査が必要な項目

1. [ ] 公式ドキュメント完全読破
2. [ ] GitHub リポジトリのソースコード確認
3. [ ] 実際のテスト実行（小規模）
4. [ ] エッジケースの動作確認

---

## フェーズ3: アーキテクチャ設計 🔨

### 3.1 MV生成パイプライン概要

```
MP3 入力
    ↓
┌─────────────────────────────────────────┐
│  フェーズ1: 分析 (Analysis)              │
│  - 音声分析                              │
│  - 歌詞抽出・解析                        │
│  - メタデータ抽出                        │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│  フェーズ2: 構想 (Conceptualization)     │
│  - ムード・テーマ決定                    │
│  - ストーリーボード生成                  │
│  - 視覚的スタイル決定                    │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│  フェーズ3: 素材準備 (Asset Preparation) │
│  - 映像素材選定/生成                     │
│  - タイミングマップ作成                  │
│  - トランジション計画                    │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│  フェーズ4: 合成 (Composition)           │
│  - 映像編集スクリプト生成                │
│  - エフェクト適用計画                    │
│  - 同期検証                              │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│  フェーズ5: 品質保証 (Quality Assurance) │
│  - 自動品質チェック                      │
│  - 問題点検出・修正                      │
│  - 最終検証                              │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│  フェーズ6: レンダリング (Rendering)     │
│  - 最終レンダリング実行                  │
│  - MP4出力                               │
└─────────────────────────────────────────┘
    ↓
MP4 出力
```

### 3.2 理論的保証（Theoretical Guarantees）

#### 正確性（Correctness）

**定義**: 生成されるMVが楽曲と完全に一致すること

**保証すべき性質**:
- ✅ **C1**: 音声と映像の同期が±1フレーム以内
- ✅ **C2**: 楽曲の長さと映像の長さが完全一致
- ✅ **C3**: ビート/テンポ情報が映像に正確に反映
- ✅ **C4**: 歌詞の意味が映像コンセプトに反映
- ✅ **C5**: 全てのフレームに映像が存在（空フレームなし）

**検証方法**:
- フレーム単位での同期チェック
- 自動テストケース（標準楽曲セット）
- 品質メトリクスの計算・閾値チェック

#### 完全性（Completeness）

**定義**: パイプライン全体が完了すること

**保証すべき性質**:
- ✅ **CP1**: 全6フェーズが実行される
- ✅ **CP2**: 各フェーズの全ステップが完了する
- ✅ **CP3**: 無限ループしない（最大iteration数で停止）
- ✅ **CP4**: 最終出力（MP4）が必ず生成される
- ✅ **CP5**: 中間ファイルが全て保存される

**検証方法**:
- フェーズ完了フラグの追跡
- タイムアウト設定（1フェーズあたり最大時間）
- 出力ファイルの存在確認

#### 一貫性（Consistency）

**定義**: 映像全体の視覚的・芸術的一貫性

**保証すべき性質**:
- ✅ **CS1**: 色調・色彩が全体で統一
- ✅ **CS2**: 視覚的スタイルの一貫性
- ✅ **CS3**: ムード・雰囲気の連続性
- ✅ **CS4**: トランジションの自然さ
- ✅ **CS5**: ストーリーボードとの整合性

**検証方法**:
- スタイルガイドの明示的定義
- カラーパレットの統一
- トランジションルールの厳格化
- フレーム間の類似度チェック

#### 品質（Quality - 最重要）

**定義**: プロフェッショナルレベルの芸術的品質

**保証すべき性質**:
- ✅ **Q1**: 解像度・ビットレートが要件を満たす
- ✅ **Q2**: 映像のシャープネス・クラリティが高い
- ✅ **Q3**: 色彩が豊かで美しい
- ✅ **Q4**: 構図・フレーミングが適切
- ✅ **Q5**: ビート/リズムとの視覚的調和
- ✅ **Q6**: 芸術的創造性が感じられる
- ✅ **Q7**: 視聴者の感情を動かす力

**検証方法**:
- 技術メトリクス（解像度、ビットレート）
- 知覚品質メトリクス（PSNR, SSIM）
- AI品質評価モデル
- **複数案生成 + ベスト選択**
- **段階的改善ループ**

#### 堅牢性（Robustness）

**定義**: エラーに対する耐性と回復力

**保証すべき性質**:
- ✅ **R1**: ツール実行失敗時の自動リトライ
- ✅ **R2**: 代替手段の自動選択
- ✅ **R3**: 部分失敗からの再開
- ✅ **R4**: エラー時の明確なログ・診断情報
- ✅ **R5**: 最悪でも低品質版のMV出力

**検証方法**:
- エラー注入テスト
- ネットワーク障害シミュレーション
- リソース不足シナリオ

### 3.3 システムアーキテクチャ

#### コンポーネント図

```
┌────────────────────────────────────────────────────┐
│           MV Orchestra Orchestrator                │
│  (claude -p ベースのメインワークフローエンジン)    │
└────────────────┬───────────────────────────────────┘
                 │
    ┌────────────┼────────────┐
    │            │            │
┌───▼────┐  ┌───▼────┐  ┌───▼────┐
│ State  │  │ Claude │  │  Tool  │
│Manager │  │ Runner │  │Executor│
└────────┘  └────────┘  └───┬────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
    ┌───▼────┐          ┌───▼────┐          ┌───▼────┐
    │Audio   │          │ Video  │          │ Render │
    │Analysis│          │Generate│          │ Engine │
    │Tools   │          │Tools   │          │        │
    └────────┘          └────────┘          └────────┘
```

#### モジュール詳細

**1. MV Orchestra Orchestrator**
- 役割: 全体の進行管理、フェーズ遷移
- 実装: Python + claude -p 統合
- 責務:
  - パイプライン進行の監視
  - フェーズ間のデータ受け渡し
  - エラーハンドリング
  - 品質ゲートチェック

**2. State Manager**
- 役割: ワークフロー状態の永続化
- 実装: Hybrid (SQLite + JSONL)
- データ:
  - 現在のフェーズ・ステップ
  - 中間生成物パス
  - 品質メトリクス
  - エラー履歴

**3. Claude Runner**
- 役割: `claude -p` の実行とレスポンス処理
- 実装: 前述の verified_claude_p_runner をベースに拡張
- 機能:
  - プロンプト生成
  - JSON出力パース
  - tool_use 抽出
  - tool_result フォーマット

**4. Tool Executor**
- 役割: 各種ツールの実行
- サブモジュール:
  - **Audio Analysis Tools**: librosa, essentia
  - **Video Generation Tools**: Stable Diffusion, RunwayML API
  - **Render Engine**: FFmpeg

### 3.4 データフロー（詳細）

#### フェーズ1: 分析

```
input.mp3
    ↓
[Audio Analysis Tool]
    ├→ tempo, beat_frames[]
    ├→ key, mode
    ├→ mood_vector
    └→ energy_curve[]
    ↓
[Lyrics Extractor]
    ├→ lyrics_text
    ├→ timestamps[]
    └→ sentiment_analysis
    ↓
analysis.json (保存)
```

#### フェーズ2: 構想

```
analysis.json
    ↓
[Claude: Concept Generation]
    ├→ overall_theme
    ├→ visual_style
    ├→ color_palette
    └→ narrative_arc
    ↓
[Claude: Storyboard Creation]
    ├→ scene_1 {description, duration, visual_elements}
    ├→ scene_2 {...}
    └→ scene_N {...}
    ↓
storyboard.json (保存)
```

#### フェーズ3: 素材準備

```
storyboard.json
    ↓
[For Each Scene]
    ↓
[Claude: Visual Direction]
    ├→ image_prompt
    ├→ style_parameters
    └→ composition_guide
    ↓
[Image Generation Tool]
    ├→ scene_001.png
    ├→ scene_002.png
    └→ ...
    ↓
assets/ (保存)
```

#### フェーズ4: 合成

```
assets/ + analysis.json + storyboard.json
    ↓
[Claude: Edit Script Generation]
    ├→ timeline: [{asset, start_time, duration, effects}...]
    ├→ transitions: [{type, duration, params}...]
    └→ synchronization: [{beat_time, visual_event}...]
    ↓
edit_script.json (保存)
```

#### フェーズ5: 品質保証

```
edit_script.json
    ↓
[Quality Checker]
    ├→ check_sync(audio, timeline)
    ├→ check_continuity(scenes)
    ├→ check_technical(resolution, framerate)
    └→ check_aesthetic(composition, color)
    ↓
[If Issues Found]
    ├→ [Claude: Problem Analysis]
    └→ [Claude: Fix Generation]
        └→ edit_script_v2.json
    ↓
validated_edit_script.json
```

#### フェーズ6: レンダリング

```
validated_edit_script.json + assets/
    ↓
[FFmpeg Render Engine]
    ├→ Composite scenes
    ├→ Apply effects
    ├→ Sync audio
    └→ Encode H.264
    ↓
output.mp4
```

### 3.5 品質保証メカニズム（重要）

#### 多段階品質チェック

```
Generate → Check → Fix → Re-check → Proceed
   ↑                           ↓
   └───────── (If still issues) ←───┘
```

#### 複数案生成 + ベスト選択

```
Input
  ↓
[Generate N variants (N=3)]
  ├→ variant_1
  ├→ variant_2
  └→ variant_3
  ↓
[Quality Scoring]
  ├→ variant_1: score=0.85
  ├→ variant_2: score=0.92 ← Best
  └→ variant_3: score=0.78
  ↓
Select variant_2
```

#### 段階的改善ループ

```
初期生成 (v1)
  ↓
[品質評価]
  ├→ 改善点リスト
  ↓
[Claude: 改善提案]
  ↓
改善版生成 (v2)
  ↓
[再評価]
  ├→ まだ改善可能？
  ↓
繰り返し (最大N回、または品質閾値到達)
  ↓
最終版
```

---

## フェーズ4: 形式的仕様（未着手）

### 4.1 状態機械

**状態**:
- `INIT`: 初期状態
- `EXECUTING`: Claude実行中
- `TOOLS_PENDING`: ツール実行待ち
- `TOOLS_EXECUTING`: ツール実行中
- `COMPLETED`: 完了
- `ERROR`: エラー

**遷移**:
```
INIT → EXECUTING → TOOLS_PENDING → TOOLS_EXECUTING → EXECUTING
                 → COMPLETED
                 → ERROR
```

詳細は後で定義。

### 4.2 不変条件（Invariants）

**I1**: `iteration_count ≥ 0`
**I2**: `for all tool_use_id: unique(tool_use_id)`
**I3**: `messages[i].timestamp < messages[i+1].timestamp`

その他、追加予定。

### 4.3 事前条件・事後条件

各関数の契約を定義（未着手）。

---

## フェーズ5: 実装計画（未着手）

### 5.1 モジュール分割

- [ ] `orchestrator.py`: メインループ
- [ ] `claude_runner.py`: Claude実行
- [ ] `tool_executor.py`: ツール実行
- [ ] `state_manager.py`: 状態管理
- [ ] `error_handler.py`: エラー処理
- [ ] その他: _______________

### 5.2 テスト戦略

- [ ] ユニットテスト
- [ ] 統合テスト
- [ ] エンドツーエンドテスト
- [ ] プロパティベーステスト
- [ ] その他: _______________

---

## フェーズ6: テスト＆検証（未着手）

### 6.1 テストケース

#### 正常系

- [ ] TC1: 単一ツール使用
- [ ] TC2: 複数ツール順次使用
- [ ] TC3: ツール未使用
- [ ] TC4: 長いワークフロー（10+ iterations）

#### 異常系

- [ ] TC5: ツール実行失敗
- [ ] TC6: ネットワークエラー
- [ ] TC7: タイムアウト
- [ ] TC8: 不正なJSON
- [ ] TC9: API制限

#### エッジケース

- [ ] TC10: 空のプロンプト
- [ ] TC11: 巨大な出力
- [ ] TC12: 特殊文字
- [ ] TC13: 並行実行

### 6.2 検証項目

- [ ] 全てのテストケースがパス
- [ ] 不変条件が常に成立
- [ ] パフォーマンス要件を満たす
- [ ] エラー処理が適切

---

## 次のステップ

### 即座に必要なこと

1. **ユーザー要件の明確化**
   - 上記の質問事項に回答
   - ユースケースの具体例

2. **技術仕様の確定**
   - `claude -p`の完全な出力構造
   - tool_resultの正しい送り方
   - エラー処理の動作

### その後の流れ

3. アーキテクチャ設計の完成
4. 形式的仕様の完成
5. 実装
6. テスト
7. 修正

---

## 付録A: 参考文献

- Claude Code CLI Reference: https://docs.claude.com/en/docs/claude-code/cli-reference
- Headless Mode: https://docs.claude.com/en/docs/claude-code/headless
- Tool Use API: https://docs.anthropic.com/en/docs/build-with-claude/tool-use

---

## 付録B: 用語集

- **Iteration**: Claude実行の1サイクル
- **tool_use**: Claudeがツール使用を要求するcontentブロック
- **tool_result**: ツール実行結果
- **stop_reason**: Claudeが停止した理由（"tool_use", "end_turn"など）

---

**ステータス**:
- ✅ フェーズ1: 要件定義 - 50%完了（ユーザー入力待ち）
- 🔍 フェーズ2: 技術仕様 - 30%完了（調査中）
- ⏸️ フェーズ3: アーキテクチャ設計 - 未着手
- ⏸️ フェーズ4: 形式的仕様 - 未着手
- ⏸️ フェーズ5: 実装計画 - 未着手
- ⏸️ フェーズ6: テスト - 未着手
